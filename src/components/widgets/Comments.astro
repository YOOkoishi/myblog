---
/**
 * Giscus 评论组件
 * 基于 GitHub Discussions 的评论系统
 * 
 * 配置步骤：
 * 1. 在 GitHub 仓库设置中启用 Discussions
 * 2. 访问 https://giscus.app/zh-CN 配置并获取参数
 * 3. 在 src/config/giscus.ts 中填入 repoId 和 categoryId
 */

import { GISCUS_CONFIG, isGiscusConfigured } from "@/config/giscus";

interface Props {
  class?: string;
}

const { class: className = "" } = Astro.props;

// 检查配置是否完成
const isConfigured = isGiscusConfigured();
---

<div class={`giscus-wrapper ${className}`}>
  {!isConfigured && (
    <div class="alert alert-warning">
      <svg
        xmlns="http://www.w3.org/2000/svg"
        class="stroke-current shrink-0 h-6 w-6"
        fill="none"
        viewBox="0 0 24 24"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"
        ></path>
      </svg>
      <div>
        <h3 class="font-bold">评论系统未配置</h3>
        <div class="text-sm">
          请按照 <a href="/docs/GISCUS_SETUP.md" class="link">配置指南</a> 在 <code>src/config/giscus.ts</code> 中配置 Giscus 参数。
        </div>
      </div>
    </div>
  )}

  <script
    src="https://giscus.app/client.js"
    data-repo={GISCUS_CONFIG.repo}
    data-repo-id={GISCUS_CONFIG.repoId}
    data-category={GISCUS_CONFIG.category}
    data-category-id={GISCUS_CONFIG.categoryId}
    data-mapping={GISCUS_CONFIG.mapping}
    data-strict={GISCUS_CONFIG.strict}
    data-reactions-enabled={GISCUS_CONFIG.reactionsEnabled}
    data-emit-metadata={GISCUS_CONFIG.emitMetadata}
    data-input-position={GISCUS_CONFIG.inputPosition}
    data-theme={GISCUS_CONFIG.theme}
    data-lang={GISCUS_CONFIG.lang}
    data-loading={GISCUS_CONFIG.loading}
    crossorigin="anonymous"
    async
  ></script>
</div>

<!-- 主题切换脚本 -->
<script is:inline>
  // 页面加载时同步主题
  function updateGiscusTheme() {
    const iframe = document.querySelector("iframe.giscus-frame");
    if (!iframe) return;

    const theme = document.documentElement.getAttribute("data-theme-type") === "dark" 
      ? "dark" 
      : "light";

    iframe.contentWindow.postMessage(
      { giscus: { setConfig: { theme } } },
      "https://giscus.app"
    );
  }

  // 监听主题切换
  document.addEventListener("astro:page-load", () => {
    // 等待 iframe 加载完成
    setTimeout(updateGiscusTheme, 1000);

    // 监听主题变化
    const observer = new MutationObserver((mutations) => {
      mutations.forEach((mutation) => {
        if (
          mutation.type === "attributes" &&
          mutation.attributeName === "data-theme-type"
        ) {
          updateGiscusTheme();
        }
      });
    });

    observer.observe(document.documentElement, {
      attributes: true,
      attributeFilter: ["data-theme-type"],
    });
  });
</script>

<style>
  .giscus-wrapper {
    margin-top: 3rem;
    padding-top: 2rem;
    border-top: 1px solid var(--fallback-bc, oklch(var(--bc) / 0.1));
  }

  /* 适配暗色主题 */
  [data-theme-type="dark"] .giscus-wrapper {
    border-top-color: var(--fallback-bc, oklch(var(--bc) / 0.2));
  }

  /* 响应式调整 */
  @media (max-width: 768px) {
    .giscus-wrapper {
      margin-top: 2rem;
      padding-top: 1.5rem;
    }
  }
</style>
